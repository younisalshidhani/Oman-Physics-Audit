import streamlit as st
import fitz 
import google.generativeai as genai

# ุฅุนุฏุงุฏ ูุงุฌูุฉ ุงูุชุทุจูู ุงูุงุญุชุฑุงููุฉ
st.set_page_config(page_title="ุงููููู ุงูุฐูู - ุณูุทูุฉ ุนูุงู", layout="wide")
st.title("๐ก๏ธ ูุธุงู ุงูุชุฏููู ูุงููุทุงุจูุฉ ุงูุซูุงุซูุฉ (ููุฒูุงุก 12)")
st.markdown("---")

with st.sidebar:
    st.header("โ๏ธ ุงูุฅุนุฏุงุฏุงุช")
    api_key = st.text_input("ุฃุฏุฎู ููุชุงุญ API ุงูุฎุงุต ุจู:", type="password")

if api_key:
    try:
        genai.configure(api_key=api_key)
        # ุงูุชุนุฏูู ุงูุฌููุฑู: ุงุณุชุฎุฏุงู ุงูููุฏูู ุงูุฐู ุธูุฑ ูู ูุงุฆูุชู ุงููุชุงุญุฉ
        model = genai.GenerativeModel('gemini-2.5-flash') 
        
        st.subheader("๐ ุชุญููู ูููุงุช ุงููุดุฑูุน")
        col1, col2, col3 = st.columns(3)
        
        with col1:
            st.info("1. ููู ุงูุงุฎุชุจุงุฑ")
            test_file = st.file_uploader("ุงุฑูุน ุงูุงุฎุชุจุงุฑ (PDF)", type="pdf", key="test")
        with col2:
            st.success("2. ูุซููุฉ ุงูุชูููู")
            policy_file = st.file_uploader("ุงุฑูุน ุงููุซููุฉ (PDF)", type="pdf", key="policy")
        with col3:
            st.warning("3. ูุชุงุจ ุงูุทุงูุจ")
            book_file = st.file_uploader("ุงุฑูุน ุตูุญุฉ ุงููุชุงุจ (PDF)", type="pdf", key="book")
        
        if test_file:
            if st.button("๐ ุจุฏุก ุงููุทุงุจูุฉ ูุงูุชุญููู ุงูุดุงูู"):
                with st.spinner("ุฌุงุฑู ูุฑุงุกุฉ ุงููููุงุช ุงูุซูุงุซุฉ ูุงููุทุงุจูุฉ ุงูุนูููุฉ..."):
                    # ูุฑุงุกุฉ ูุตูุต ุงููููุงุช
                    def get_text(file):
                        doc = fitz.open(stream=file.read(), filetype="pdf")
                        return "".join([page.get_text() for page in doc])

                    t_text = get_text(test_file)
                    p_text = get_text(policy_file) if policy_file else "ุงุนุชูุฏ ุนูู ูุนุงููุฑ ุงูุงุฎุชุจุงุฑ ุงููุตูุฑ (10 ุฏุฑุฌุงุช)"
                    b_text = get_text(book_file) if book_file else "ุงุนุชูุฏ ุนูู ุฏุฑุณ ุชุฃุซูุฑ ุฏูุจูุฑ ุต 32"

                    prompt = f"""
                    ุจุตูุชู ุฎุจูุฑ ุฌูุฏุฉ ุชุฑุจูู ูู ุณูุทูุฉ ุนูุงูุ ูู ุจุฅุฌุฑุงุก ูุทุงุจูุฉ ุซูุงุซูุฉ ุจูู:
                    1. ูุซููุฉ ุงูุชูููู ุงููุฑููุฉ: {p_text}
                    2. ูุชุงุจ ุงูุทุงูุจ ุงููุฑูู: {b_text}
                    
                    ูุชุญููู ุงูุงุฎุชุจุงุฑ ุงูุชุงูู: {t_text}
                    
                    ุงููุทููุจ ุจุฏูุฉ:
                    - ุฌุฏูู Markdown ุจุงูุฃุนูุฏุฉ (ุฑูู ุงูููุฑุฏุฉุ ุงูุฏุฑุฌุฉุ ููุน ูุฏู ุงูุชููููุ ููุน ุงูููุงุญุธุฉุ ุงูููุงุญุธุงุชุ ุงูุชุนุฏูู ุงูููุชุฑุญ).
                    - ุชูุตูุฉ ููุงุฆูุฉ ููุณุจุฉ ูุทุงุจูุฉ (%).
                    """
                    
                    # ุฅุฑุณุงู ุงูุทูุจ ูุน ุชุนูููุงุช ุชูุณูู ุตุงุฑูุฉ
                response = model.generate_content(prompt)
                
                st.markdown("---")
                st.success("โ ุงูุชููุช ุงููุทุงุจูุฉ ุงูุซูุงุซูุฉ ุจูุฌุงุญ!")
                
                # ุงุณุชุฎุฏุงู ุญุงููุฉ ููุธูุฉ ูุนุฑุถ ุงููุชุงุฆุฌ
                tab1, tab2 = st.tabs(["๐ ุฌุฏูู ุงูุชุญููู ุงูููู", "๐ ุงูุชูุตูุงุช ูุงููุณุจุฉ"])
                
                with tab1:
                    st.subheader("ุชุญููู ููุฑุฏุงุช ุงูุงุฎุชุจุงุฑ")
                    # ุนุฑุถ ุงูุฑุฏ ููุง ููุ ูุณูููู Streamlit ุจุชูุณูู ุงูุฌุฏูู ุชููุงุฆูุงู
                    st.markdown(response.text)
                
                with tab2:
                    st.subheader("ุงูุฎูุงุตุฉ ุงูุชุฑุจููุฉ")
                    st.info("ุฑุงุฌุน ุงูุชูุตูุงุช ุงูููุงุฆูุฉ ููุณุจุฉ ุงููุทุงุจูุฉ ูู ููุงูุฉ ุงูุฌุฏูู ุฃุนูุงู.")
