import streamlit as st
import fitz 
import google.generativeai as genai

# 1. ุฅุนุฏุงุฏุงุช ุงูุตูุญุฉ ูุงููุงุฌูุฉ ุงูุนุฑุจูุฉ
st.set_page_config(page_title="ุงููููู ุงูุชุฑุจูู ุงูุนูุงูู ุงูุฐูู", layout="wide")

st.markdown("""
    <style>
    .stApp { direction: rtl; text-align: right; }
    .official-header { background-color: #f0f7ff; padding: 25px; border-radius: 15px; border-right: 10px solid #007bff; margin-bottom: 30px; }
    .report-container { border: 1px solid #e0e0e0; padding: 20px; border-radius: 10px; background-color: #ffffff; }
    </style>
    """, unsafe_allow_html=True)

# 2. ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ (Sidebar) ุจุงูุชุฑุชูุจ ุงููุทููุจ
with st.sidebar:
    st.header("โ๏ธ ุฎูุงุฑุงุช ุงูุชุฏููู")
    api_key = st.text_input("ููุชุงุญ API:", type="password")
    
    subject = st.selectbox("ุงููุงุฏุฉ:", ["ููุฒูุงุก", "ููููุงุก", "ุฃุญูุงุก", "ุงูุนููู ุงูุจูุฆูุฉ"])
    semester = st.selectbox("ุงููุตู ุงูุฏุฑุงุณู:", ["ุงูุฃูู", "ุงูุซุงูู"])
    grade_level = st.selectbox("ุงููุฑุญูุฉ ุงูุตููุฉ:", ["ุงูุญุงุฏู ุนุดุฑ", "ุงูุซุงูู ุนุดุฑ"])
    exam_type = st.selectbox("ููุน ุงูุงุฎุชุจุงุฑ:", ["ูุตูุฑ", "ุงุณุชูุตุงุฆู"])
    
    pg_range = st.text_input("ูุทุงู ุงูุตูุญุงุช (ูุซูุงู 77-97):", help="ุญุฏุฏ ุตูุญุงุช ุงููุชุงุจ ุงููุฑุชุจุทุฉ ุจุงูุงุฎุชุจุงุฑ ุจุฏูุฉ")

# 3. ุงูููุทู ุงูุจุฑูุฌู ููุนุงูุฌุฉ ุงููููุงุช
if api_key:
    try:
        # ุงุณุชุฎุฏุงู ุงููุณุฎุฉ ุงููุณุชูุฑุฉ ูู ุงูููุฏูู
        genai.configure(api_key=api_key)
        model = genai.GenerativeModel('gemini-1.5-flash') 
        
        st.markdown(f'<div class="official-header"><h2>ุชุญููู ุจูุงูุงุช ุงูุงุฎุชุจุงุฑ ({exam_type}) - ูุงุฏุฉ {subject}</h2></div>', unsafe_allow_html=True)
        
        col1, col2, col3 = st.columns(3)
        with col1: t_file = st.file_uploader("๐ 1. ููู ุงูุงุฎุชุจุงุฑ (PDF)", type="pdf")
        with col2: p_file = st.file_uploader("๐ 2. ูุซููุฉ ุงูุชูููู (PDF)", type="pdf")
        with col3: b_file = st.file_uploader("๐ 3. ูุชุงุจ ุงูุทุงูุจ (PDF)", type="pdf")
        
        if t_file and st.button("๐ ุฅุตุฏุงุฑ ุงูุชูุฑูุฑ ุงูุฑุณูู"):
            with st.spinner("ุฌุงุฑู ุงูุชูุนู ูู ุงูููุฑุฏุงุช ูุงูุฑุณูู ูุญุณุงุจ ุงูุฏุฑุฌุงุช..."):
                
                def extract_data(file, r=None):
                    doc = fitz.open(stream=file.read(), filetype="pdf")
                    if r:
                        try:
                            s, e = map(int, r.split('-'))
                            return "".join([doc[i].get_text() for i in range(s-1, min(e, len(doc)))])
                        except: return "".join([p.get_text() for p in doc])
                    return "".join([p.get_text() for p in doc])

                test_content = extract_data(t_file)
                policy_content = extract_data(p_file) if p_file else "ุงููุนุงููุฑ ุงูุฑุณููุฉ"
                book_content = extract_data(b_file, pg_range) if b_file else "ูุญุชูู ุงููุชุงุจ"

                # 4. ุงูุจุฑููุจุช ุงููุตูู ุทุจูุงู ููููุฐุฌ Word ุงููุฑูู
                prompt = f"""
                ุจุตูุชู ุฎุจูุฑ ุฌูุฏุฉ ุชุฑุจูู ูู ุณูุทูุฉ ุนูุงูุ ุญูู ุงูุงุฎุชุจุงุฑ ุงููุฑูู ููุงุฏุฉ {subject} ุจูุงุกู ุนูู "ูููุฐุฌ ุชูุฑูุฑ ุชุทุจูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู".
                
                ุงูููุงู ุงููุทููุจุฉ:
                1. ุงูุฌุฏูู ุงูุฃูู: ุชุญููู ูู ููุฑุฏุฉ ุงูุชุญุงููุฉ (ุงููุฏูุ AO1/AO2ุ ุงูุฏุฑุฌุฉุ ุงูููุงุญุธุฉุ ุงูุชุนุฏูู).
                2. ุงูุฌุฏูู ุงูุซุงูู (ุงูุฌุฏูู ุงูุนุงูู): 
                   - ุงุญุณุจ ุนุฏุฏ ุงูุฏุฑูุณ ุงููุนููุฉ ุจูุทุงุจูุฉ ููุฑุฏุงุช ุงูุงุฎุชุจุงุฑ ูุน ุนูุงููู ุงูุฏุฑูุณ ูู ุตูุญุงุช ุงููุชุงุจ ุงููุฑููุฉ: {pg_range}.
                   - ุงุฌูุน ุฏุฑุฌุงุช ุฃูุฏุงู ุงูุชูููู AO1 ู AO2 ุจุดูู ุฏููู.
                   - ุชุญูู ูู ูุฌูุฏ ููุฑุฏุงุช ุงุฎุชูุงุฑ ูู ูุชุนุฏุฏ (ุงูุนุฏุฏ ูุงููุดุชุชุงุช ุงูููุทููุฉ).
                
                ุงููุฎุฑุฌุงุช (ุงูุชุฒู ุจูุฐู ุงูุนูุงููู ุญุฑููุงู):

                ### ุฌุฏูู ุชุญููู ุงูููุฑุฏุงุช ุงูุงูุชุญุงููุฉ
                | ุงูููุฑุฏุฉ | ุงููุฏู ุงูุชุนูููู | ูุฏู ุงูุชูููู (AO1,AO2) | ุงูุฏุฑุฌุฉ | ููุน ุงูููุงุญุธุฉ (ุตูุงุบุฉุ ุนูููุฉุ ูููุฉ ุชุดูู ุงูุฑุณู) | ุงูููุงุญุธุฉ | ุงูุชุนุฏูู |
                |---|---|---|---|---|---|---|

                ### ุงูุฌุฏูู ุงูุนุงูู ููุงุฎุชุจุงุฑ ุงููุตูุฑ
                | ุงูุจูุฏ | ุงูุนุฏุฏ / ุงูุฏุฑุฌุงุช โ ูุนู / ูุง | ูุทุงุจู / ุบูุฑ ูุทุงุจู |
                |---|---|---|
                | ุนุฏุฏ ุงูููุฑุฏุงุช | | |
                | ุนุฏุฏ ุงูุฏุฑูุณ | | - |
                | ุฏุฑุฌุงุช ุฃูุฏุงู ุงูุชูููู (AO1,AO2) | | |
                | ูู ุชูุฌุฏ ููุฑุฏุฉ ุทูููุฉ ุงูุฅุฌุงุจุฉุ | | |
                | ูู ุชูุฌุฏ ููุฑุฏุชุงู ุงุฎุชูุงุฑ ูู ูุชุนุฏุฏุ | | |
                | ูู ููุฑุฏุงุช ุงูุงุฎุชูุงุฑ ูู ูุชุนุฏุฏ ุชุญุชูู ุนูู (ุฅุฌุงุจุงุช ุฎุงุทุฆุฉ) ูุดุชุชุงุช ููุทููุฉุ | | |
                | ูู ุตูุงุบุฉ ุงูููุฑุฏุงุช ูุญุฌู ูููุน ุงูุฎุท ูุงุถุญ ูููุฑุงุกุฉุ | | |
                | ูู ุงูุฃุดูุงู ูุงูุฑุณููุงุช ูุงุถุญุฉุ | | |

                ### ุงูุชูุฏูุฑ ุงูุนุงู ููุงุฎุชุจุงุฑ ุงููุตูุฑ
                (ุงูุชุจ ููุง ูุณุชูู ุงูุงุฎุชุจุงุฑ ุจุดูู ุนุงู ููุฎุชุตุฑ ููุณุจุฉ ูุทุงุจูุชู ูููุนุงููุฑ ุจุฏูู ุฅุทุงูุฉ).

                ุงูุจูุงูุงุช ุงููุฑุฌุนูุฉ:
                - ุงูุงุฎุชุจุงุฑ: {test_content}
                - ุงููุชุงุจ: {book_content[:7000]}
                - ุงููุซููุฉ: {policy_content[:2000]}
                """
                
                response = model.generate_content(prompt)
                st.session_state.final_report = response.text

        if "final_report" in st.session_state:
            st.markdown("---")
            st.markdown('<div class="report-container">', unsafe_allow_html=True)
            st.markdown(st.session_state.final_report)
            st.markdown('</div>', unsafe_allow_html=True)
            st.download_button("๐ฅ ุชุญููู ุงูุชูุฑูุฑ ุงูููุงุฆู", st.session_state.final_report, "Official_Audit_Report.txt")

    except Exception as e:
        st.error(f"ุชูุจูู: ุชุฃูุฏ ูู ุชุญุฏูุซ ููุชุจุฉ google-generativeai ูู ููู requirements.txt. ุงูุฎุทุฃ ุงูุญุงูู: {e}")
else:
    st.info("ุงูุฑุฌุงุก ุฅุฏุฎุงู ููุชุงุญ API ููุจุฏุก ูู ุนูููุฉ ุงูุชุญููู.")
