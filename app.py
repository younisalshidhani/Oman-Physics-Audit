import streamlit as st
import fitz 
import google.generativeai as genai

# ุฅุนุฏุงุฏ ุงูุตูุญุฉ ูุชูุงุณุจ ูุงูุฉ ุงูููุงุฏ
st.set_page_config(page_title="ุงููููู ุงูุชุฑุจูู ุงูุดุงูู", layout="wide")

st.markdown("""
    <div style="background-color:#ffffff;padding:20px;border-radius:15px;border-right:10px solid #2ecc71;box-shadow: 2px 2px 15px rgba(0,0,0,0.1)">
        <h1 style="margin:0;color:#2c3e50">๐ก๏ธ ุงููููู ุงูุชุฑุจูู ุงูุฐูู</h1>
        <p style="margin:0;color:#7f8c8d">ูุธุงู ุงููุทุงุจูุฉ ุงูุซูุงุซูุฉ ููููุงูุฌ ุงูุนูุงููุฉ (ุฌููุน ุงูููุงุฏ)</p>
    </div>
    """, unsafe_allow_html=True)

with st.sidebar:
    st.header("๐ ุงูุชูุนูู")
    api_key = st.text_input("ุฃุฏุฎู ููุชุงุญ API ุงูุฎุงุต ุจู:", type="password")

if api_key:
    try:
        genai.configure(api_key=api_key)
        model = genai.GenerativeModel('gemini-2.5-flash') 
        
        st.write("### ๐ ุชุญููู ุงููุณุชูุฏุงุช ุงูุญุงููุฉ")
        col1, col2, col3 = st.columns(3)
        with col1: test_file = st.file_uploader("๐ ููู ุงูุงุฎุชุจุงุฑ ุงููุฑุงุฏ ุชุญูููู", type="pdf")
        with col2: policy_file = st.file_uploader("๐ ูุซููุฉ ุงูุชูููู ุงูุฎุงุตุฉ ุจุงููุงุฏุฉ", type="pdf")
        with col3: book_file = st.file_uploader("๐ ุงููุฑุฌุน ุงูุนููู (ูุชุงุจ ุงูุทุงูุจ)", type="pdf")
        
        if test_file and st.button("๐ ุจุฏุก ุงูุชุญููู ุงูุชุฑุจูู ุงูุดุงูู"):
            with st.spinner("ุฌุงุฑู ูุฑุงุกุฉ ุงููููุงุช ูุฅุฌุฑุงุก ุงููุทุงุจูุฉ ุงูุฏูููุฉ..."):
                def get_text(file):
                    doc = fitz.open(stream=file.read(), filetype="pdf")
                    return "".join([page.get_text() for page in doc])

                t_text = get_text(test_file)
                p_text = get_text(policy_file) if policy_file else "ุงุนุชูุฏ ุนูู ุงููุนุงููุฑ ุงูุชุฑุจููุฉ ุงูุนุงูุฉ ููุงุฎุชุจุงุฑุงุช ุงููุตูุฑุฉ."
                b_text = get_text(book_file) if book_file else "ุงุนุชูุฏ ุนูู ุงููุญุชูู ุงูุนููู ุงููุชุนุงุฑู ุนููู ูููุงุฏุฉ."

                # ุงูุจุฑููุจุช ุงูุดุงูู ุงูุฐู ุทูุจุชู ูุน ุดุฑูุท ุงูุชูุธูู
                prompt = f"""
                ุจุตูุชู ุฎุจูุฑ ุฌูุฏุฉ ูุชุฑุจูุฉุ ูู ุจุฅุฌุฑุงุก ูุทุงุจูุฉ ุฏูููุฉ ุจูู ุงููุฑุงุฌุน ุงููุฑููุฉ ูุจูู ููู ุงูุงุฎุชุจุงุฑ.
                
                1. ุงุณุชุฎุฏู "ูุซููุฉ ุงูุชูููู" ุงููุฑููุฉ ูุงุณุชุฎุฑุงุฌ ุงููุนุงููุฑ (ุงูุฏุฑุฌุงุชุ ุชูุฒูุน ุงูุฃูุฏุงู).
                2. ุงุณุชุฎุฏู "ูุชุงุจ ุงูุทุงูุจ" ุงููุฑูู ููุชุฃูุฏ ูู ุตุญุฉ ุงููุนูููุงุช ุงูุนูููุฉ ูุงููุตุทูุญุงุช.
                3. ุญูู "ููู ุงูุงุฎุชุจุงุฑ" ุจูุงุกู ุนููููุง.
                
                ุงููุฑุงุฌุน ุงูุญุงููุฉ:
                - ุงููุซููุฉ: {p_text}
                - ุงููุชุงุจ: {b_text}
                - ุงูุงุฎุชุจุงุฑ: {t_text}
                
                ุงููุทููุจ:
                - ุฌุฏูู Markdown ุงุญุชุฑุงูู: (ุงูููุฑุฏุฉ | ุงูุฏุฑุฌุฉ | ุงููุฏู | ููุน ุงูููุงุญุธุฉ | ุงูููุงุญุธุฉ | ุงูุชุนุฏูู).
                - ูุณุจุฉ ูุทุงุจูุฉ ุงูุงุฎุชุจุงุฑ ูููุนุงููุฑ ุงููุฑููุฉ (%) ุจูุงุกู ุนูู ุชุญููู ุงูุฃูุฏุงู ูุงููุญุชูู.
                - ุชูุตูุฉ ููุงุฆูุฉ ุดุงููุฉ ูู ุณุทุฑ ูุงุญุฏ ููุท.
                
                ุดุฑูุท ุงูุนุฑุถ: ุงูุงุฎุชุตุงุฑ ุงูุดุฏูุฏ ูู ุงูููุงุญุธุงุชุ ุนุฏู ูุชุงุจุฉ ููุฏูุงุชุ ูุงุณุชุฎุฏุงู ูุบุฉ ุชุฑุจููุฉ ุฏูููุฉ.
                """
                
                response = model.generate_content(prompt)
                
                st.markdown("---")
                st.subheader("๐ ูุชุงุฆุฌ ุงููุทุงุจูุฉ ูุงูุชุญููู")
                
                # ุนุฑุถ ุงููุชูุฌุฉ ูู ููุทูุฉ ูุงุถุญุฉ
                st.markdown(response.text)
                
    except Exception as e:
        st.error(f"ุญุฏุซ ุชูุจูู: {e}")
else:
    st.info("ูุฑุฌู ุฅุฏุฎุงู ููุชุงุญ API ููุจุฏุก ูู ุชุญููู ุงููุงุฏุฉ ุงููุฑููุฉ.")
